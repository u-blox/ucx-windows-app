<!DOCTYPE html>
<!--
  Copyright 2025 u-blox

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCX Web Terminal - NORA-W36</title>
    <link rel="icon" type="image/x-icon" href="images/ShortRange.ico">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #003366;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        input[type="text"], input[type="password"], select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.disconnected {
            background: #ffe6e6;
            color: #cc0000;
        }
        .status.connected {
            background: #e6ffe6;
            color: #006600;
        }
        .wifi-network {
            padding: 10px;
            margin: 5px 0;
            background: #f9f9f9;
            border-left: 4px solid #0066cc;
            cursor: pointer;
        }
        .wifi-network:hover {
            background: #e6f2ff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üåê UCX Web Terminal - NORA-W36</h1>
    
    <div class="section">
        <h2>Serial Connection</h2>
        <div id="serialStatus" class="status disconnected">Not Connected</div>
        <button id="connectBtn" onclick="connectSerial()" disabled>Connect to Serial Port</button>
        <button id="disconnectBtn" onclick="disconnectSerial()" disabled>Disconnect</button>
        <p>Baud Rate: <select id="baudRate">
            <option value="115200" selected>115200</option>
            <option value="921600">921600</option>
            <option value="460800">460800</option>
            <option value="230400">230400</option>
        </select></p>
    </div>

    <div class="section">
        <h2>WiFi Scan</h2>
        <button onclick="wifiScan()" id="scanBtn" disabled>Scan Networks</button>
        <div id="scanResults"></div>
    </div>

    <div class="section">
        <h2>WiFi Connection</h2>
        <p>
            SSID: <input type="text" id="ssid" placeholder="Network name"><br>
            Password: <input type="password" id="password" placeholder="Password">
        </p>
        <button onclick="wifiConnect()" id="connectWifiBtn" disabled>Connect</button>
        <button onclick="wifiDisconnect()" id="disconnectWifiBtn" disabled>Disconnect</button>
        <button onclick="getConnectionInfo()" id="connectionInfoBtn" disabled>Get Connection Info</button>
        <div id="connectionInfo"></div>
    </div>

    <div class="section">
        <h2>AT Commands</h2>
        <p>
            <input type="text" id="atCommand" placeholder="Enter AT command (e.g., AT+UWSCAN)" style="width: 400px;">
            <button onclick="sendATCommand()" id="sendATBtn" disabled>Send</button>
        </p>
        <p style="font-size: 12px; color: #666;">
            Examples: AT+GMR (firmware version), AT+UWSCAN (WiFi scan), AT+UWSC=0,3,0 (connect to SSID in slot 0)
        </p>
    </div>

    <div class="section">
        <h2>Console Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log" class="log"></div>
    </div>

    <script src="ucxclient.js"></script>
    <script>
        let ucxModule = null;
        let ucxHandle = 0;
        let serialPort = null;
        let receiveBuffer = [];
        let reader = null;
        let isReading = false;

        // Log to console and UI
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            const logDiv = document.getElementById('log');
            logDiv.textContent += logMessage + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Update UI status
        function updateSerialStatus(connected) {
            const statusDiv = document.getElementById('serialStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const scanBtn = document.getElementById('scanBtn');
            const connectWifiBtn = document.getElementById('connectWifiBtn');
            const disconnectWifiBtn = document.getElementById('disconnectWifiBtn');
            const connectionInfoBtn = document.getElementById('connectionInfoBtn');

            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                scanBtn.disabled = false;
                connectWifiBtn.disabled = false;
                disconnectWifiBtn.disabled = false;
                connectionInfoBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Not Connected';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                scanBtn.disabled = true;
                connectWifiBtn.disabled = true;
                disconnectWifiBtn.disabled = true;
                connectionInfoBtn.disabled = true;
            }
        }

        // Read from serial port continuously
        async function readSerial() {
            isReading = true;
            try {
                reader = serialPort.readable.getReader();
                
                while (isReading) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }
                    
                    // Add to receive buffer
                    receiveBuffer.push(...value);
                    console.log('[DEBUG] RX: Received', value.length, 'bytes, buffer now has', receiveBuffer.length, 'bytes');
                    
                    // Debug: show received data
                    const text = new TextDecoder().decode(value);
                    log(`RX: ${text}`);
                    console.log('[DEBUG] RX data:', text.trim());
                }
            } catch (error) {
                log(`Read error: ${error}`);
            } finally {
                if (reader) {
                    reader.releaseLock();
                    reader = null;
                }
            }
        }

        // Connect to serial port
        async function connectSerial() {
            try {
                // Check if WASM module is loaded
                if (!ucxModule) {
                    alert('WASM module not loaded yet. Please wait a moment and try again.');
                    return;
                }

                // Check Web Serial API support
                if (!('serial' in navigator)) {
                    alert('Web Serial API not supported. Use Chrome or Edge browser.');
                    return;
                }

                // Request port
                serialPort = await navigator.serial.requestPort();
                
                // Open with selected baud rate
                const baudRate = parseInt(document.getElementById('baudRate').value);
                await serialPort.open({ baudRate });
                
                log(`Serial port opened at ${baudRate} baud`);
                
                // Make available to WASM module
                ucxModule.serialPort = serialPort;
                ucxModule.receiveBuffer = receiveBuffer;
                
                // Start reading
                readSerial();
                
                // Initialize UCX client
                const portName = '';
                const portNameLen = ucxModule.lengthBytesUTF8(portName) + 1;
                const portNamePtr = ucxModule._malloc(portNameLen);
                ucxModule.stringToUTF8(portName, portNamePtr, portNameLen);
                
                const result = ucxModule.ccall('ucx_init', 'number', ['number', 'number'], [portNamePtr, 115200]);
                ucxModule._free(portNamePtr);
                
                if (result !== 0) {
                    throw new Error('Failed to initialize UCX client');
                }
                ucxHandle = 1; // Mark as initialized
                log('UCX client initialized');
                
                updateSerialStatus(true);
            } catch (error) {
                log(`Connection error: ${error}`);
                alert(`Failed to connect: ${error.message}`);
            }
        }

        // Disconnect serial port
        async function disconnectSerial() {
            try {
                // Stop reading
                isReading = false;
                if (reader) {
                    await reader.cancel();
                }
                
                // Destroy UCX client
                if (ucxHandle !== 0) {
                    ucxModule.ccall('ucx_deinit', null, [], []);
                    ucxHandle = 0;
                }
                
                // Close port
                if (serialPort) {
                    await serialPort.close();
                    serialPort = null;
                }
                
                log('Serial port closed');
                updateSerialStatus(false);
            } catch (error) {
                log(`Disconnect error: ${error}`);
            }
        }

        // WiFi scan
        async function wifiScan() {
            try {
                console.log('[DEBUG] === wifiScan() called ===');
                log('Starting WiFi scan...');
                
                console.log('[DEBUG] Calling ucx_wifi_scan_begin');
                const scanId = ucxModule.ccall('ucx_wifi_scan_begin', 'number', [], []);
                console.log('[DEBUG] ucx_wifi_scan_begin returned:', scanId);
                if (scanId < 0) {
                    throw new Error('Failed to start WiFi scan');
                }
                
                // Wait for scan to complete (simplified - in real app, poll or use callback)
                console.log('[DEBUG] Waiting 5 seconds for scan to complete...');
                await new Promise(resolve => setTimeout(resolve, 5000));
                console.log('[DEBUG] Wait complete, retrieving results');
                
                // Get scan results
                const networks = [];
                const ssidPtr = ucxModule._malloc(33); // SSID buffer (32 + null terminator)
                const rssiPtr = ucxModule._malloc(4);  // int32
                const channelPtr = ucxModule._malloc(4); // int32
                console.log('[DEBUG] Allocated memory - ssidPtr:', ssidPtr, 'rssiPtr:', rssiPtr, 'channelPtr:', channelPtr);
                
                let scanIndex = 0;
                while (true) {
                    console.log('[DEBUG] Calling ucx_wifi_scan_get_next, iteration:', scanIndex);
                    const ret = ucxModule.ccall('ucx_wifi_scan_get_next', 'number', 
                        ['number', 'number', 'number'], 
                        [ssidPtr, rssiPtr, channelPtr]);
                    console.log('[DEBUG] ucx_wifi_scan_get_next returned:', ret);
                    
                    if (ret !== 1) {
                        console.log('[DEBUG] No more results (ret=' + ret + '), breaking loop');
                        break; // 0 = no more results, -1 = error
                    }
                    
                        const ssid = ucxModule.UTF8ToString(ssidPtr);
                        const rssi = ucxModule.readInt32(rssiPtr);
                        const channel = ucxModule.readInt32(channelPtr);
                        console.log('[DEBUG] Network', scanIndex, '- SSID:', ssid, 'RSSI:', rssi, 'Channel:', channel);
                        
                        networks.push({ ssid, rssi, channel });
                        scanIndex++;
                    }                ucxModule._free(ssidPtr);
                ucxModule._free(rssiPtr);
                ucxModule._free(channelPtr);
                console.log('[DEBUG] Freed memory');
                
                console.log('[DEBUG] Calling ucx_wifi_scan_end');
                ucxModule.ccall('ucx_wifi_scan_end', null, [], []);
                console.log('[DEBUG] Scan complete, total networks:', networks.length);
                log(`Found ${networks.length} networks`);
                
                // Display results
                const resultsDiv = document.getElementById('scanResults');
                if (networks.length === 0) {
                    resultsDiv.innerHTML = '<p>No networks found</p>';
                } else {
                    let html = '<table><tr><th>SSID</th><th>Channel</th><th>RSSI</th><th>Action</th></tr>';
                    for (const net of networks) {
                        html += `<tr><td>${net.ssid}</td><td>${net.channel}</td><td>${net.rssi} dBm</td><td><button onclick="selectNetwork('${net.ssid}')">Select</button></td></tr>`;
                    }
                    html += '</table>';
                    resultsDiv.innerHTML = html;
                }
                
                log(`Found ${networks.length} networks`);
            } catch (error) {
                log(`Scan error: ${error}`);
            }
        }

        // Select network from scan results
        function selectNetwork(ssid) {
            document.getElementById('ssid').value = ssid;
        }

        // WiFi connect
        async function wifiConnect() {
            try {
                const ssid = document.getElementById('ssid').value;
                const password = document.getElementById('password').value;
                
                if (!ssid) {
                    alert('Please enter SSID');
                    return;
                }
                
                log(`Connecting to ${ssid}...`);
                
                const ssidPtr = ucxModule._malloc(ucxModule.lengthBytesUTF8(ssid) + 1);
                const passPtr = ucxModule._malloc(ucxModule.lengthBytesUTF8(password) + 1);
                
                ucxModule.stringToUTF8(ssid, ssidPtr, ucxModule.lengthBytesUTF8(ssid) + 1);
                ucxModule.stringToUTF8(password, passPtr, ucxModule.lengthBytesUTF8(password) + 1);
                
                const ret = ucxModule.ccall('ucx_wifi_connect', 'number', ['number', 'number'], [ssidPtr, passPtr]);
                
                ucxModule._free(ssidPtr);
                ucxModule._free(passPtr);
                
                if (ret === 0) {
                    log('WiFi connected successfully');
                    // Wait a bit then get connection info
                    setTimeout(getConnectionInfo, 2000);
                } else {
                    log(`WiFi connection failed (error: ${ret})`);
                }
            } catch (error) {
                log(`Connect error: ${error}`);
            }
        }

        // WiFi disconnect
        async function wifiDisconnect() {
            try {
                log('Disconnecting WiFi...');
                
                const ret = ucxModule.ccall('ucx_wifi_disconnect', 'number', [], []);
                
                if (ret === 0) {
                    log('WiFi disconnected');
                    document.getElementById('connectionInfo').innerHTML = '';
                } else {
                    log(`WiFi disconnect failed (error: ${ret})`);
                }
            } catch (error) {
                log(`Disconnect error: ${error}`);
            }
        }

        // Get connection info
        async function getConnectionInfo() {
            try {
                log('Getting connection info...');
                
                const infoPtr = ucxModule._malloc(256);
                const ret = ucxModule.ccall('ucx_wifi_get_ip', 'number', ['number'], [infoPtr]);
                
                if (ret === 0) {
                    const info = ucxModule.UTF8ToString(infoPtr);
                    log(`Connection info: ${info}`);
                    
                    // Display in UI
                    const infoDiv = document.getElementById('connectionInfo');
                    infoDiv.innerHTML = `<pre>${info}</pre>`;
                } else {
                    log(`Failed to get connection info (error: ${ret})`);
                }
                
                ucxModule._free(infoPtr);
            } catch (error) {
                log(`Get info error: ${error}`);
            }
        }

        // URC callback handler
        function handleURC(urc) {
            log(`[URC] ${urc}`);
            
            // Handle specific URCs
            if (urc.includes('+UUWLE:')) {
                log('WiFi connection state changed');
            }
        }

        // Initialize WASM module
        createUCXModule().then(module => {
            ucxModule = module;
            ucxModule.receiveBuffer = receiveBuffer;
            ucxModule.onURC = handleURC;
            
            // Attach serial port functions that are called from WASM
            ucxModule.serialPort = null; // Will be set when connected
            ucxModule.writeQueue = Promise.resolve(); // Write queue to prevent lock conflicts
            
            ucxModule.serialWrite = function(buffer) {
                try {
                    console.log('[DEBUG] serialWrite called, buffer length:', buffer.length);
                    if (!ucxModule.serialPort || !ucxModule.serialPort.writable) {
                        console.error('[serialWrite] Serial port not writable');
                        log('[ERROR] Serial port not writable');
                        return -1;
                    }
                    
                    // Convert to string for logging
                    const text = new TextDecoder().decode(buffer);
                    log(`TX (${buffer.length} bytes): ${text.trim()}`);
                    console.log('[DEBUG] Writing to serial:', text.trim());
                    
                    // Queue the write to prevent lock conflicts
                    ucxModule.writeQueue = ucxModule.writeQueue.then(async () => {
                        const writer = ucxModule.serialPort.writable.getWriter();
                        try {
                            await writer.write(buffer);
                            console.log('[DEBUG] Write completed successfully');
                        } catch (error) {
                            console.error('[serialWrite] Write error:', error);
                        } finally {
                            writer.releaseLock();
                        }
                    });
                    
                    return buffer.length;
                } catch (error) {
                    console.error('[serialWrite] Error:', error);
                    log(`[ERROR] serialWrite: ${error.message}`);
                    return -1;
                }
            };
            
            ucxModule.serialRead = function(maxLength) {
                try {
                    console.log('[DEBUG] serialRead called, maxLength:', maxLength, 'buffer has:', ucxModule.receiveBuffer?.length || 0);
                    if (!ucxModule.receiveBuffer || ucxModule.receiveBuffer.length === 0) {
                        console.log('[DEBUG] serialRead: no data available');
                        return null;
                    }
                    
                    // Read up to maxLength bytes from buffer
                    const length = Math.min(maxLength, ucxModule.receiveBuffer.length);
                    const data = ucxModule.receiveBuffer.slice(0, length);
                    
                    // Remove read data from buffer
                    ucxModule.receiveBuffer = ucxModule.receiveBuffer.slice(length);
                    
                    console.log('[DEBUG] serialRead returning', length, 'bytes');
                    return new Uint8Array(data);
                } catch (error) {
                    console.error('[serialRead] Error:', error);
                    return null;
                }
            };
            
            // Helper to read int32 from WASM memory
            ucxModule.readInt32 = function(ptr) {
                // Get memory buffer - try different property names
                let buffer;
                if (ucxModule.HEAP8) {
                    buffer = ucxModule.HEAP8.buffer;
                } else if (ucxModule.wasmMemory) {
                    buffer = ucxModule.wasmMemory.buffer;
                } else if (ucxModule.memory) {
                    buffer = ucxModule.memory.buffer;
                }
                
                if (!buffer) {
                    console.error('[readInt32] Cannot find WASM memory buffer');
                    return 0;
                }
                
                const view = new Int32Array(buffer, ptr, 1);
                return view[0];
            };
            
            ucxModule.serialAvailable = function() {
                try {
                    if (!ucxModule.receiveBuffer) {
                        return 0;
                    }
                    const available = ucxModule.receiveBuffer.length;
                    if (available > 0) {
                        console.log('[DEBUG] serialAvailable:', available, 'bytes');
                    }
                    return available;
                } catch (error) {
                    console.error('[serialAvailable] Error:', error);
                    return 0;
                }
            };
            
            log('UCX WASM module loaded successfully');
            log('Click "Connect to Serial Port" to begin');
            
            // Enable the connect button now that module is loaded
            document.getElementById('connectBtn').disabled = false;
        }).catch(error => {
            log(`Failed to load WASM module: ${error}`);
            alert(`Failed to load UCX module: ${error.message}`);
        });
    </script>
</body>
</html>
