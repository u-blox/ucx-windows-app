<!DOCTYPE html>
<!--
  Copyright 2025 u-blox

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCX Web App - NORA-W36</title>
    <link rel="icon" type="image/x-icon" href="images/ShortRange.ico">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #003366;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        input[type="text"], input[type="password"], select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.disconnected {
            background: #ffe6e6;
            color: #cc0000;
        }
        .status.connected {
            background: #e6ffe6;
            color: #006600;
        }
        .wifi-network {
            padding: 10px;
            margin: 5px 0;
            background: #f9f9f9;
            border-left: 4px solid #0066cc;
            cursor: pointer;
        }
        .wifi-network:hover {
            background: #e6f2ff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üåê UCX Web Terminal - NORA-W36</h1>
    
    <div class="section">
        <h2>Serial Connection</h2>
        <div id="serialStatus" class="status disconnected">Not Connected</div>
        <button id="connectBtn" onclick="connectSerial()" disabled>Connect to Serial Port</button>
        <button id="disconnectBtn" onclick="disconnectSerial()" disabled>Disconnect</button>
        <p>Baud Rate: <select id="baudRate">
            <option value="115200" selected>115200</option>
            <option value="921600">921600</option>
            <option value="460800">460800</option>
            <option value="230400">230400</option>
        </select></p>
    </div>

    <div class="section">
        <h2>WiFi Scan</h2>
        <button onclick="wifiScan()" id="scanBtn" disabled>Scan Networks</button>
        <div id="scanResults"></div>
    </div>

    <div class="section">
        <h2>WiFi Connection</h2>
        <p>
            SSID: <input type="text" id="ssid" placeholder="Network name"><br>
            Password: <input type="password" id="password" placeholder="Password">
        </p>
        <button onclick="wifiConnect()" id="connectWifiBtn" disabled>Connect</button>
        <button onclick="wifiDisconnect()" id="disconnectWifiBtn" disabled>Disconnect</button>
        <button onclick="getConnectionInfo()" id="connectionInfoBtn" disabled>Get Connection Info</button>
        <div id="connectionInfo"></div>
    </div>

    <div class="section">
        <h2>Console Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log" class="log"></div>
    </div>

    <script src="ucxclient.js"></script>
    <script>
        let ucxModule = null;
        let ucxHandle = 0;
        let serialPort = null;
        let receiveBuffer = [];
        let reader = null;
        let isReading = false;

        // Log to console and UI
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            const logDiv = document.getElementById('log');
            logDiv.textContent += logMessage + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Update UI status
        function updateSerialStatus(connected) {
            const statusDiv = document.getElementById('serialStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const scanBtn = document.getElementById('scanBtn');
            const connectWifiBtn = document.getElementById('connectWifiBtn');
            const disconnectWifiBtn = document.getElementById('disconnectWifiBtn');
            const connectionInfoBtn = document.getElementById('connectionInfoBtn');

            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                scanBtn.disabled = false;
                connectWifiBtn.disabled = false;
                disconnectWifiBtn.disabled = false;
                connectionInfoBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Not Connected';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                scanBtn.disabled = true;
                connectWifiBtn.disabled = true;
                disconnectWifiBtn.disabled = true;
                connectionInfoBtn.disabled = true;
            }
        }

        // Read from serial port continuously
        async function readSerial() {
            isReading = true;
            try {
                reader = serialPort.readable.getReader();
                
                while (isReading) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }
                    
                    // Add to receive buffer
                    receiveBuffer.push(...value);
                    
                    // Debug: show received data
                    const text = new TextDecoder().decode(value);
                    const displayText = text.trim();
                    
                    // Highlight important responses
                    let logPrefix = 'RX';
                    if (displayText.includes('+UUWLE')) {
                        logPrefix = 'RX [WIFI-URC]';
                        console.log('[SERIAL-READ] üü¢ WiFi URC detected!');
                    } else if (displayText.includes('OK')) {
                        logPrefix = 'RX [OK]';
                    } else if (displayText.includes('ERROR')) {
                        logPrefix = 'RX [ERROR]';
                        console.log('[SERIAL-READ] üî¥ ERROR response detected!');
                    }
                    
                    if (displayText.length > 0) {
                        log(`${logPrefix}: ${displayText}`);
                        console.log('[SERIAL-READ] Data:', displayText);
                    }
                    console.log('[SERIAL-READ] Buffer status: received', value.length, 'bytes, buffer now has', receiveBuffer.length, 'bytes');
                }
            } catch (error) {
                log(`Read error: ${error}`);
            } finally {
                if (reader) {
                    reader.releaseLock();
                    reader = null;
                }
            }
        }

        // Auto-connect to previously paired port
        async function autoConnectSerial() {
            try {
                // Check if WASM module is loaded
                if (!ucxModule) {
                    console.log('WASM module not loaded yet, skipping auto-connect');
                    return;
                }

                // Check Web Serial API support
                if (!('serial' in navigator)) {
                    return;
                }

                // Get previously paired ports
                const ports = await navigator.serial.getPorts();
                if (ports.length === 0) {
                    log('No previously paired serial ports found. Click "Connect to Serial Port" to select a device.');
                    return;
                }

                // Use the first paired port
                serialPort = ports[0];
                log(`Found previously paired port, connecting automatically...`);
                
                // Open with selected baud rate
                const baudRate = parseInt(document.getElementById('baudRate').value);
                await serialPort.open({ baudRate });
                
                log(`Serial port opened at ${baudRate} baud`);
                
                // Make available to WASM module
                ucxModule.serialPort = serialPort;
                
                // Start reading
                readSerial();
                
                // Initialize UCX client
                log('Initializing UCX client...');
                console.log('[AUTO-CONNECT] Calling ucx_init with baudRate:', baudRate);
                
                const result = await ucxModule.ccall('ucx_init', 'number', ['string', 'number'], ['', baudRate]);
                console.log('[AUTO-CONNECT] ucx_init returned:', result);
                
                if (result !== 0) {
                    throw new Error('Failed to initialize UCX client (error code: ' + result + ')');
                }
                ucxHandle = 1; // Mark as initialized
                log('UCX client initialized');
                log('Auto-connected successfully! You can now scan WiFi networks.');
                
                updateSerialStatus(true);
            } catch (error) {
                log(`Auto-connect failed: ${error.message}. Click "Connect to Serial Port" to select manually.`);
                console.error('Auto-connect error:', error);
            }
        }

        // Connect to serial port (manual)
        async function connectSerial() {
            try {
                // Check if WASM module is loaded
                if (!ucxModule) {
                    alert('WASM module not loaded yet. Please wait a moment and try again.');
                    return;
                }

                // Check Web Serial API support
                if (!('serial' in navigator)) {
                    alert('Web Serial API not supported. Use Chrome or Edge browser.');
                    return;
                }

                // Request port (user selects)
                serialPort = await navigator.serial.requestPort();
                
                // Open with selected baud rate
                const baudRate = parseInt(document.getElementById('baudRate').value);
                await serialPort.open({ baudRate });
                
                log(`Serial port opened at ${baudRate} baud`);
                
                // Make available to WASM module
                ucxModule.serialPort = serialPort;
                
                // Start reading
                readSerial();
                
                // Initialize UCX client
                log('Initializing UCX client...');
                console.log('[MANUAL-CONNECT] Calling ucx_init with baudRate:', baudRate);
                
                const result = await ucxModule.ccall('ucx_init', 'number', ['string', 'number'], ['', baudRate]);
                console.log('[MANUAL-CONNECT] ucx_init returned:', result);
                
                if (result !== 0) {
                    throw new Error('Failed to initialize UCX client (error code: ' + result + ')');
                }
                ucxHandle = 1; // Mark as initialized
                log('UCX client initialized');
                
                updateSerialStatus(true);
            } catch (error) {
                log(`Connection error: ${error}`);
                alert(`Failed to connect: ${error.message}`);
            }
        }

        // Disconnect serial port
        async function disconnectSerial() {
            try {
                // Stop reading
                isReading = false;
                if (reader) {
                    await reader.cancel();
                }
                
                // Destroy UCX client
                if (ucxHandle !== 0) {
                    ucxModule.ccall('ucx_deinit', null, [], []);
                    ucxHandle = 0;
                }
                
                // Close port
                if (serialPort) {
                    await serialPort.close();
                    serialPort = null;
                }
                
                log('Serial port closed');
                updateSerialStatus(false);
            } catch (error) {
                log(`Disconnect error: ${error}`);
            }
        }

        // WiFi scan
        async function wifiScan() {
            try {
                console.log('[DEBUG] === wifiScan() called ===');
                log('Starting WiFi scan...');
                
                console.log('[DEBUG] Calling ucx_wifi_scan_begin');
                const scanId = ucxModule.ccall('ucx_wifi_scan_begin', 'number', [], []);
                console.log('[DEBUG] ucx_wifi_scan_begin returned:', scanId);
                if (scanId < 0) {
                    throw new Error('Failed to start WiFi scan');
                }
                
                // Wait for scan to complete (simplified - in real app, poll or use callback)
                console.log('[DEBUG] Waiting 5 seconds for scan to complete...');
                await new Promise(resolve => setTimeout(resolve, 5000));
                console.log('[DEBUG] Wait complete, retrieving results');
                
                // Get scan results
                const networks = [];
                const ssidPtr = ucxModule._malloc(33); // SSID buffer (32 + null terminator)
                const rssiPtr = ucxModule._malloc(4);  // int32
                const channelPtr = ucxModule._malloc(4); // int32
                console.log('[DEBUG] Allocated memory - ssidPtr:', ssidPtr, 'rssiPtr:', rssiPtr, 'channelPtr:', channelPtr);
                
                let scanIndex = 0;
                while (true) {
                    console.log('[DEBUG] Calling ucx_wifi_scan_get_next, iteration:', scanIndex);
                    const ret = ucxModule.ccall('ucx_wifi_scan_get_next', 'number', 
                        ['number', 'number', 'number'], 
                        [ssidPtr, rssiPtr, channelPtr]);
                    console.log('[DEBUG] ucx_wifi_scan_get_next returned:', ret);
                    
                    if (ret !== 1) {
                        console.log('[DEBUG] No more results (ret=' + ret + '), breaking loop');
                        break; // 0 = no more results, -1 = error
                    }
                    
                        const ssid = ucxModule.UTF8ToString(ssidPtr);
                        const rssi = ucxModule.readInt32(rssiPtr);
                        const channel = ucxModule.readInt32(channelPtr);
                        console.log('[DEBUG] Network', scanIndex, '- SSID:', ssid, 'RSSI:', rssi, 'Channel:', channel);
                        
                        networks.push({ ssid, rssi, channel });
                        scanIndex++;
                    }                ucxModule._free(ssidPtr);
                ucxModule._free(rssiPtr);
                ucxModule._free(channelPtr);
                console.log('[DEBUG] Freed memory');
                
                console.log('[DEBUG] Calling ucx_wifi_scan_end');
                ucxModule.ccall('ucx_wifi_scan_end', null, [], []);
                console.log('[DEBUG] Scan complete, total networks:', networks.length);
                log(`Found ${networks.length} networks`);
                
                // Display results
                const resultsDiv = document.getElementById('scanResults');
                if (networks.length === 0) {
                    resultsDiv.innerHTML = '<p>No networks found</p>';
                } else {
                    let html = '<table><tr><th>SSID</th><th>Channel</th><th>RSSI</th><th>Action</th></tr>';
                    for (const net of networks) {
                        html += `<tr><td>${net.ssid}</td><td>${net.channel}</td><td>${net.rssi} dBm</td><td><button onclick="selectNetwork('${net.ssid}')">Select</button></td></tr>`;
                    }
                    html += '</table>';
                    resultsDiv.innerHTML = html;
                }
                
                log(`Found ${networks.length} networks`);
            } catch (error) {
                log(`Scan error: ${error}`);
            }
        }

        // Select network from scan results
        function selectNetwork(ssid) {
            document.getElementById('ssid').value = ssid;
        }

        // WiFi connect
        async function wifiConnect() {
            try {
                const ssid = document.getElementById('ssid').value;
                const password = document.getElementById('password').value;
                
                if (!ssid) {
                    alert('Please enter SSID');
                    return;
                }
                
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                log(`üîÑ STARTING WiFi Connection Process`);
                log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
                log(`Target SSID: "${ssid}"`);
                log(`Password: ${password ? `"${password.substring(0, 3)}***" (${password.length} chars)` : '(none - open network)'}`);
                
                // Pre-flight checks
                console.log('[WIFI-CONNECT] Pre-flight checks:');
                console.log('[WIFI-CONNECT]   - ucxModule:', ucxModule ? 'OK' : 'NULL');
                console.log('[WIFI-CONNECT]   - ucxHandle:', ucxHandle);
                console.log('[WIFI-CONNECT]   - serialPort:', ucxModule.serialPort ? 'OK' : 'NULL');
                console.log('[WIFI-CONNECT]   - receiveBuffer length:', receiveBuffer.length);
                
                log('üì° Calling WASM ucx_wifi_connect function...');
                log('Parameters:');
                log(`  - SSID: "${ssid}"`);
                log(`  - Password: ${password ? '"***" (set)' : '"" (empty)'}`);
                log('This may take 10-15 seconds...');
                
                // Call with string parameters directly (Emscripten will convert)
                // Note: With ASYNCIFY, this returns a Promise
                console.log(`[WIFI-CONNECT] About to call ucx_wifi_connect`);
                console.log(`[WIFI-CONNECT] SSID: "${ssid}", password: "${password ? '***' : '(none)'}"`);
                
                const startTime = Date.now();
                const ret = await ucxModule.ccall('ucx_wifi_connect', 'number', ['string', 'string'], [ssid, password || '']);
                const elapsed = Date.now() - startTime;
                
                console.log(`[WIFI-CONNECT] ucx_wifi_connect returned: ${ret} (took ${elapsed}ms)`);
                log(`‚è±Ô∏è  Call completed in ${elapsed}ms`);
                log(`üì• Return value: ${ret}`);
                
                if (ret === 0) {
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    log('‚úÖ WiFi connect command sent successfully');
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    log('‚è≥ Waiting for connection to establish (5 seconds)...');
                    // Wait a bit then get connection info
                    setTimeout(() => {
                        log('üîç Checking connection status...');
                        getConnectionInfo();
                    }, 5000);
                } else {
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    log(`‚ùå WiFi connection FAILED`);
                    log(`Error code: ${ret}`);
                    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    log('üí° Troubleshooting:');
                    log('   - Check SSID spelling');
                    log('   - Verify password is correct');
                    log('   - Ensure network is in range');
                    log('   - Check console for detailed error messages');
                }
            } catch (error) {
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                log(`‚ùå EXCEPTION during WiFi connect: ${error}`);
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('[WIFI-CONNECT] Exception:', error);
                console.error('[WIFI-CONNECT] Stack trace:', error.stack);
            }
        }

        // WiFi disconnect
        async function wifiDisconnect() {
            try {
                log('Disconnecting WiFi...');
                
                const ret = await ucxModule.ccall('ucx_wifi_disconnect', 'number', [], []);
                
                if (ret === 0) {
                    log('‚úÖ WiFi disconnected successfully');
                    document.getElementById('connectionInfo').innerHTML = '';
                } else {
                    log(`‚ùå WiFi disconnect failed (error: ${ret})`);
                }
            } catch (error) {
                log(`‚ùå Disconnect error: ${error}`);
            }
        }

        // Get connection info
        async function getConnectionInfo() {
            try {
                log('Getting connection info...');
                
                const infoPtr = ucxModule._malloc(256);
                const ret = await ucxModule.ccall('ucx_wifi_get_ip', 'number', ['number'], [infoPtr]);
                
                if (ret === 0) {
                    const info = ucxModule.UTF8ToString(infoPtr);
                    log(`‚úÖ IP Address: ${info}`);
                    
                    // Display in UI
                    const infoDiv = document.getElementById('connectionInfo');
                    infoDiv.innerHTML = `<div style="background:#e6ffe6;padding:10px;border-radius:4px;"><strong>‚úÖ Connected!</strong><br>IP Address: <code>${info}</code></div>`;
                } else {
                    log(`Failed to get connection info (error: ${ret})`);
                }
                
                ucxModule._free(infoPtr);
            } catch (error) {
                log(`Get info error: ${error}`);
            }
        }

        // URC callback handler
        function handleURC(urc) {
            // Don't log every URC to the UI, only important ones
            console.log('[URC-HANDLER] Received URC:', urc);
            
            // Handle WiFi Link Event: +UEWLU:<wlan_handle>,<bssid>,<link_up>
            if (urc.includes('+UEWLU:')) {
                const match = urc.match(/\+UEWLU:(\d+),([0-9A-F]+),(\d+)/);
                if (match) {
                    const wlanHandle = match[1];
                    const bssid = match[2];
                    const linkUp = match[3];
                    
                    if (linkUp === '1') {
                        log(`‚úÖ WiFi LINK UP - Connected to AP (BSSID: ${bssid})`);
                        console.log('[URC-HANDLER] WiFi connected, getting IP address...');
                        // Wait a moment for DHCP to complete
                        setTimeout(() => getConnectionInfo(), 2000);
                    } else {
                        log(`‚ùå WiFi LINK DOWN - Disconnected from AP`);
                    }
                } else {
                    log(`[URC] ${urc}`);
                }
                return;
            }
            
            // Handle WiFi Station Network Up: +UEWSNU (DHCP succeeded)
            if (urc.includes('+UEWSNU')) {
                log('üåê WiFi Station Network UP - DHCP completed');
                console.log('[URC-HANDLER] DHCP completed, getting connection info');
                setTimeout(() => getConnectionInfo(), 500);
                return;
            }
            
            // Handle WiFi Station Network Down
            if (urc.includes('+UEWSND')) {
                log('üìµ WiFi Station Network DOWN');
                return;
            }
            
            // Handle old-style WiFi link event (if module sends it)
            if (urc.includes('+UUWLE:')) {
                const match = urc.match(/\+UUWLE:(\d+),(\d+)/);
                if (match) {
                    const wlanHandle = match[1];
                    const linkStatus = match[2];
                    
                    if (linkStatus === '1') {
                        log('‚úÖ WiFi CONNECTED!');
                        setTimeout(() => getConnectionInfo(), 1000);
                    } else if (linkStatus === '0') {
                        log('‚ùå WiFi DISCONNECTED');
                    }
                }
                return;
            }
            
            // Log other URCs for debugging
            if (urc.includes('+UUPSND:') || urc.includes('+UUDPC:')) {
                console.log('[URC-HANDLER] Network event:', urc);
                // Don't log to UI, too verbose
            } else {
                // Unknown URC, log to UI
                log(`[URC] ${urc}`);
            }
        }

        // Initialize WASM module
        createUCXModule().then(module => {
            ucxModule = module;
            ucxModule.onURC = handleURC;
            
            // Attach serial port functions that are called from WASM
            ucxModule.serialPort = null; // Will be set when connected
            ucxModule.writeQueue = Promise.resolve(); // Write queue to prevent lock conflicts
            
            ucxModule.serialWrite = function(buffer) {
                try {
                    console.log('[SERIAL-WRITE] Called with buffer length:', buffer.length);
                    if (!ucxModule.serialPort || !ucxModule.serialPort.writable) {
                        console.error('[SERIAL-WRITE] ‚ùå Serial port not writable');
                        log('[ERROR] Serial port not writable');
                        return -1;
                    }
                    
                    // Convert to string for logging
                    const text = new TextDecoder().decode(buffer);
                    const displayText = text.trim();
                    
                    // Highlight important AT commands
                    let logPrefix = 'TX';
                    if (displayText.includes('AT+UWSC')) {
                        logPrefix = 'TX [WIFI-CONNECT]';
                        console.log('[SERIAL-WRITE] üîµ WiFi connect command detected!');
                    } else if (displayText.includes('AT+UWSCP')) {
                        logPrefix = 'TX [WIFI-PARAMS]';
                        console.log('[SERIAL-WRITE] üîµ WiFi params command detected!');
                    } else if (displayText.includes('AT+UWSSE')) {
                        logPrefix = 'TX [WIFI-SECURITY]';
                        console.log('[SERIAL-WRITE] üîµ WiFi security command detected!');
                    }
                    
                    log(`${logPrefix} (${buffer.length} bytes): ${displayText}`);
                    console.log('[SERIAL-WRITE] Data:', displayText);
                    
                    // Queue the write to prevent lock conflicts
                    ucxModule.writeQueue = ucxModule.writeQueue.then(async () => {
                        const writer = ucxModule.serialPort.writable.getWriter();
                        try {
                            await writer.write(buffer);
                            console.log('[SERIAL-WRITE] ‚úÖ Write completed successfully');
                        } catch (error) {
                            console.error('[SERIAL-WRITE] ‚ùå Write error:', error);
                        } finally {
                            writer.releaseLock();
                        }
                    });
                    
                    return buffer.length;
                } catch (error) {
                    console.error('[SERIAL-WRITE] ‚ùå Exception:', error);
                    log(`[ERROR] serialWrite: ${error.message}`);
                    return -1;
                }
            };
            
            ucxModule.serialRead = function(maxLength) {
                try {
                    if (!receiveBuffer || receiveBuffer.length === 0) {
                        return null;
                    }
                    
                    // Read up to maxLength bytes from buffer
                    const length = Math.min(maxLength, receiveBuffer.length);
                    const data = receiveBuffer.slice(0, length);
                    
                    // Remove read data from buffer - use splice to modify in place
                    receiveBuffer.splice(0, length);
                    
                    return new Uint8Array(data);
                } catch (error) {
                    console.error('[serialRead] Error:', error);
                    return null;
                }
            };
            
            // Helper to read int32 from WASM memory
            ucxModule.readInt32 = function(ptr) {
                // Get memory buffer - try different property names
                let buffer;
                if (ucxModule.HEAP8) {
                    buffer = ucxModule.HEAP8.buffer;
                } else if (ucxModule.wasmMemory) {
                    buffer = ucxModule.wasmMemory.buffer;
                } else if (ucxModule.memory) {
                    buffer = ucxModule.memory.buffer;
                }
                
                if (!buffer) {
                    console.error('[readInt32] Cannot find WASM memory buffer');
                    return 0;
                }
                
                const view = new Int32Array(buffer, ptr, 1);
                return view[0];
            };
            
            ucxModule.serialAvailable = function() {
                try {
                    if (!receiveBuffer) {
                        return 0;
                    }
                    const available = receiveBuffer.length;
                    if (available > 0) {
                        console.log('[SERIAL-AVAILABLE] Buffer has', available, 'bytes');
                    }
                    return available;
                } catch (error) {
                    console.error('[SERIAL-AVAILABLE] Error:', error);
                    return 0;
                }
            };
            
            log('UCX WASM module loaded successfully');
            log('Checking for previously paired serial ports...');
            
            // Enable the connect button now that module is loaded
            document.getElementById('connectBtn').disabled = false;
            
            // Try to auto-connect to previously paired port
            setTimeout(autoConnectSerial, 500);
        }).catch(error => {
            log(`Failed to load WASM module: ${error}`);
            alert(`Failed to load UCX module: ${error.message}`);
        });
    </script>
</body>
</html>
